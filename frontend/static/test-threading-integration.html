<!DOCTYPE html>
<html>
<head>
    <title>üßµ Threading Integration Test</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 20px; 
            background: #1a1a1a; 
            color: #e0e0e0; 
        }
        .pass { color: #4caf50; }
        .fail { color: #f44336; }
        .warn { color: #ff9800; }
        .info { color: #2196f3; }
        pre { 
            background: #333; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto;
        }
        .status { margin: 10px 0; padding: 5px; }
    </style>
</head>
<body>
    <h1>üßµ Threading Integration Test</h1>
    <p>Testing the new multithreaded WASM integration implementation.</p>
    <div id="results"></div>
    
    <script type="module">
        function log(message, type = 'info') {
            const div = document.getElementById('results');
            div.innerHTML += `<div class="status ${type}">[${new Date().toLocaleTimeString()}] ${message}</div>`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function testThreadingIntegration() {
            try {
                log('üöÄ Starting Threading Integration Test (v2 - Fixed Placeholder)', 'info');
                
                // Test 1: Environment Check
                log('üìã Checking Environment...', 'info');
                log(`Cross-Origin Isolated: ${self.crossOriginIsolated}`, 
                    self.crossOriginIsolated ? 'pass' : 'fail');
                log(`SharedArrayBuffer: ${typeof SharedArrayBuffer !== 'undefined'}`, 
                    typeof SharedArrayBuffer !== 'undefined' ? 'pass' : 'fail');
                log(`Hardware Concurrency: ${navigator.hardwareConcurrency || 'unknown'}`, 'info');
                
                // Test 2: Import WASM Module  
                log('üì¶ Importing WASM Module...', 'info');
                const wasmModule = await import('/wasm/vectorize_wasm.js');
                log('‚úì WASM module imported successfully', 'pass');
                
                // Test 3: Initialize with proper wasm-bindgen pattern
                log('üîß Initializing WASM with wasm-bindgen pattern...', 'info');
                await wasmModule.default('/wasm/vectorize_wasm_bg.wasm');
                log('‚úì WASM module initialized (LinkError should be resolved!)', 'pass');
                
                // Test 4: Check if start function exists (new threading init)
                if (typeof wasmModule.start === 'function') {
                    log('üßµ Initializing thread pool...', 'info');
                    try {
                        await wasmModule.start();
                        log('‚úì Thread pool initialized successfully', 'pass');
                    } catch (e) {
                        log(`‚ö†Ô∏è Thread pool init failed: ${e.message}`, 'warn');
                        log('(This is expected if not cross-origin isolated)', 'info');
                    }
                } else {
                    log('‚ö†Ô∏è No start() function found - using single-threaded mode', 'warn');
                }
                
                // Test 5: Test threading functions (should be real, not stubs)
                log('üîç Testing threading functions...', 'info');
                
                const threadingFunctions = [
                    'get_thread_count',
                    'is_threading_active', 
                    'get_threading_info'
                ];
                
                for (const funcName of threadingFunctions) {
                    if (typeof wasmModule[funcName] === 'function') {
                        try {
                            const result = wasmModule[funcName]();
                            log(`‚úì ${funcName}(): ${result}`, 'pass');
                        } catch (e) {
                            log(`‚ùå ${funcName}() error: ${e.message}`, 'fail');
                        }
                    } else {
                        log(`‚ùå ${funcName} not found`, 'fail');
                    }
                }
                
                // Test 6: Test basic vectorization
                log('üéØ Testing basic vectorization...', 'info');
                try {
                    // Create test image data
                    const canvas = document.createElement('canvas');
                    canvas.width = canvas.height = 100;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, 100, 100);
                    ctx.fillStyle = 'black';
                    ctx.fillRect(25, 25, 50, 50);
                    
                    const imageData = ctx.getImageData(0, 0, 100, 100);
                    
                    if (wasmModule.WasmVectorizer) {
                        const vectorizer = new wasmModule.WasmVectorizer();
                        const startTime = performance.now();
                        const svg = vectorizer.vectorize(imageData);
                        const endTime = performance.now();
                        
                        log(`‚úì Vectorization successful: ${svg.length} chars in ${(endTime - startTime).toFixed(1)}ms`, 'pass');
                        vectorizer.free();
                    } else {
                        log('‚ùå WasmVectorizer class not found', 'fail');
                    }
                    
                } catch (e) {
                    log(`‚ùå Vectorization failed: ${e.message}`, 'fail');
                }
                
                // Test 7: Summary
                log('üìä Test Summary', 'info');
                log('üéâ Threading Integration Test Complete!', 'pass');
                
                if (self.crossOriginIsolated) {
                    log('‚úÖ Full multithreading support available', 'pass');
                } else {
                    log('‚ö†Ô∏è Single-threaded mode (add COOP/COEP headers for threading)', 'warn');
                }
                
            } catch (error) {
                log(`üí• Integration test failed: ${error.message}`, 'fail');
                log(`Stack: ${error.stack}`, 'fail');
                
                // Check for specific LinkError
                if (error.message.includes('__wbindgen_describe')) {
                    log('‚ùå LinkError still present - wasm-bindgen integration issue', 'fail');
                } else {
                    log('‚ÑπÔ∏è Different error type - LinkError appears to be resolved', 'info');
                }
            }
        }

        // Run test when page loads
        window.addEventListener('load', testThreadingIntegration);
    </script>
</body>
</html>