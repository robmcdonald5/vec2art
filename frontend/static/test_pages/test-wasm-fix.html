<!doctype html>
<html>
	<head>
		<title>WASM Fix Test</title>
		<style>
			body {
				font-family: monospace;
				padding: 20px;
			}
			.success {
				color: green;
			}
			.error {
				color: red;
			}
			.warning {
				color: orange;
			}
			.info {
				color: blue;
			}
			pre {
				background: #f5f5f5;
				padding: 10px;
				margin: 10px 0;
			}
		</style>
	</head>
	<body>
		<h1>WASM Binding Fix Test</h1>
		<div id="output"></div>

		<script type="module">
			const output = document.getElementById('output');

			function log(message, type = 'info') {
				const div = document.createElement('div');
				div.className = type;
				div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
				output.appendChild(div);
				console.log(message);
			}

			async function testWasmFix() {
				try {
					log('üîß Testing WASM binding fixes...', 'info');

					// Test 1: Check Cross-Origin Isolation
					if (window.crossOriginIsolated) {
						log('‚úÖ Cross-Origin Isolation enabled', 'success');
					} else {
						log('‚ö†Ô∏è Cross-Origin Isolation disabled - threading will not work', 'warning');
					}

					// Test 2: Check SharedArrayBuffer support
					if (typeof SharedArrayBuffer !== 'undefined') {
						log('‚úÖ SharedArrayBuffer available', 'success');
					} else {
						log('‚ùå SharedArrayBuffer unavailable', 'error');
					}

					// Test 3: Import WASM module
					log('üì¶ Importing WASM module...', 'info');
					const wasm = await import('./wasm/vectorize_wasm.js');
					log('‚úÖ WASM module imported successfully', 'success');

					// Test 4: Check for key functions
					const functions = [
						'initThreadPool',
						'confirm_threading_success',
						'mark_threading_failed',
						'WasmVectorizer'
					];
					functions.forEach((fn) => {
						if (typeof wasm[fn] !== 'undefined') {
							log(`‚úÖ Function ${fn} available`, 'success');
						} else {
							log(`‚ùå Function ${fn} missing`, 'error');
						}
					});

					// Test 5: Initialize WASM
					log('üöÄ Initializing WASM module...', 'info');
					await wasm.default('/wasm/vectorize_wasm_bg.wasm');
					log('‚úÖ WASM module initialized successfully', 'success');

					// Test 6: Thread pool initialization (DISABLED to prevent CPU spin)
					log('‚ö†Ô∏è Thread pool initialization DISABLED to prevent CPU spin', 'warning');
					if (false && typeof wasm.initThreadPool === 'function' && window.crossOriginIsolated) {
						log('üßµ Attempting thread pool initialization...', 'info');
						try {
							const threadCount = navigator.hardwareConcurrency || 4;
							const promise = wasm.initThreadPool(threadCount);
							await promise;

							if (typeof wasm.confirm_threading_success === 'function') {
								wasm.confirm_threading_success();
							}

							log(`‚úÖ Thread pool initialized with ${threadCount} threads`, 'success');

							// Test thread status functions
							if (typeof wasm.get_thread_count === 'function') {
								const count = wasm.get_thread_count();
								log(`‚úÖ Active thread count: ${count}`, 'success');
							}

							if (typeof wasm.is_threading_supported === 'function') {
								const supported = wasm.is_threading_supported();
								log(`‚úÖ Threading supported: ${supported}`, 'success');
							}
						} catch (error) {
							log(`‚ùå Thread pool initialization failed: ${error.message}`, 'error');
							if (typeof wasm.mark_threading_failed === 'function') {
								wasm.mark_threading_failed();
							}
						}
					} else {
						log('‚ÑπÔ∏è Thread pool not available or cross-origin isolated', 'info');
					}

					// Test 7: Create vectorizer instance
					if (typeof wasm.WasmVectorizer !== 'undefined') {
						log('üé® Testing vectorizer creation...', 'info');
						try {
							// Create a small test image (2x2 pixels)
							const testImageData = new Uint8Array([
								255, 0, 0, 255, 0, 255, 0, 255, 0, 0, 255, 255, 255, 255, 0, 255
							]);
							const vectorizer = new wasm.WasmVectorizer(testImageData, 2, 2);
							log('‚úÖ Vectorizer instance created successfully', 'success');

							// Test configuration
							vectorizer.set_backend('edge');
							vectorizer.set_detail(0.5);
							log('‚úÖ Vectorizer configuration successful', 'success');
						} catch (error) {
							log(`‚ùå Vectorizer creation failed: ${error.message}`, 'error');
						}
					} else {
						log('‚ùå WasmVectorizer not available', 'error');
					}

					log('üéâ WASM fix test complete!', 'success');
				} catch (error) {
					log(`‚ùå WASM fix test failed: ${error.message}`, 'error');
					console.error('Full error:', error);
				}
			}

			// Run test when page loads
			testWasmFix();
		</script>
	</body>
</html>
