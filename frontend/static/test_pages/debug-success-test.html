<!DOCTYPE html>
<html>
<head>
    <title>🎉 Debug Success Test</title>
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #e0e0e0; padding: 20px; }
        .pass { color: #4caf50; } .fail { color: #f44336; } .info { color: #2196f3; }
        .status { margin: 8px 0; padding: 4px 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>🎉 Debug Success Test</h1>
    <div id="log"></div>
    
    <script type="module">
        const log = (msg, type = 'info') => {
            document.getElementById('log').innerHTML += `<div class="status ${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            console.log(`[${type.toUpperCase()}] ${msg}`);
        };
        
        async function debugTest() {
            try {
                log('🎉 Testing the fixed WASM integration...', 'info');
                
                // Environment check
                log(`Environment: Cross-Origin Isolated = ${self.crossOriginIsolated}`, 'info');
                
                // The moment of truth
                log('📦 Importing WASM module with fixed absolute paths...', 'info');
                const wasm = await import('/wasm/vectorize_wasm.js');
                log('✅ SUCCESS: WASM module imported with absolute path imports!', 'pass');
                
                // Test initialization
                log('🔧 Initializing WASM...', 'info');
                await wasm.default('/wasm/vectorize_wasm_bg.wasm');
                log('✅ SUCCESS: WASM initialized!', 'pass');
                
                // Test thread pool (if cross-origin isolated)
                if (typeof wasm.start === 'function' && self.crossOriginIsolated) {
                    log('🧵 Initializing thread pool...', 'info');
                    try {
                        await wasm.start();
                        log('✅ SUCCESS: Thread pool initialized!', 'pass');
                        
                        if (typeof wasm.get_thread_count === 'function') {
                            const threads = wasm.get_thread_count();
                            log(`✅ SUCCESS: ${threads} threads active!`, 'pass');
                        }
                    } catch (e) {
                        log(`⚠️ Threading failed: ${e.message}`, 'info');
                    }
                } else if (!self.crossOriginIsolated) {
                    log('ℹ️ Single-threaded mode (cross-origin isolation disabled)', 'info');
                } else {
                    log('⚠️ Threading start function not available', 'info');
                }
                
                // Test vectorizer
                if (typeof wasm.WasmVectorizer === 'function') {
                    log('🎨 Testing vectorization...', 'info');
                    
                    // Create test image
                    const canvas = document.createElement('canvas');
                    canvas.width = canvas.height = 20;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, 20, 20);
                    ctx.fillStyle = 'black';
                    ctx.fillRect(5, 5, 10, 10);
                    
                    const imageData = ctx.getImageData(0, 0, 20, 20);
                    
                    const vectorizer = new wasm.WasmVectorizer();
                    const startTime = performance.now();
                    const svg = vectorizer.vectorize(imageData);
                    const endTime = performance.now();
                    
                    vectorizer.free();
                    
                    const processingTime = endTime - startTime;
                    log(`✅ SUCCESS: Vectorized in ${processingTime.toFixed(1)}ms -> ${svg.length} chars`, 'pass');
                }
                
                log('🎉🎉🎉 ALL TESTS PASSED! MULTITHREADED WASM INTEGRATION COMPLETE! 🎉🎉🎉', 'pass');
                
            } catch (error) {
                log(`❌ Test failed: ${error.message}`, 'fail');
                console.error('Error details:', error);
            }
        }
        
        debugTest();
    </script>
</body>
</html>