<!doctype html>
<html>
	<head>
		<title>Worker Test</title>
		<style>
			body {
				font-family: monospace;
				padding: 20px;
				background: #1a1a1a;
				color: #e0e0e0;
			}
			.pass {
				color: #4caf50;
			}
			.fail {
				color: #f44336;
			}
			.info {
				color: #2196f3;
			}
			button {
				background: #4fc3f7;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 4px;
				cursor: pointer;
				margin: 10px 0;
			}
			button:hover {
				background: #29b6f6;
			}
		</style>
	</head>
	<body>
		<h1>Worker Loading Test</h1>
		<button onclick="testWorker()">Test Worker</button>
		<div id="results"></div>

		<script type="module">
			const log = (msg, type = 'info') => {
				const div = document.createElement('div');
				div.className = type;
				div.textContent = `${new Date().toISOString().split('T')[1].split('.')[0]} - ${msg}`;
				document.getElementById('results').appendChild(div);
			};

			// Check environment first
			log(
				`crossOriginIsolated: ${window.crossOriginIsolated}`,
				window.crossOriginIsolated ? 'pass' : 'fail'
			);
			log(
				`SharedArrayBuffer: ${typeof SharedArrayBuffer !== 'undefined'}`,
				typeof SharedArrayBuffer !== 'undefined' ? 'pass' : 'fail'
			);

			window.testWorker = async function () {
				log('Testing worker creation...', 'info');

				try {
					// Create a simple test worker
					const workerCode = `
                    self.onmessage = async (event) => {
                        console.log('Worker received message:', event.data);
                        
                        if (event.data.type === 'init') {
                            try {
                                // Test importing WASM module
                                const wasmModule = await import('/wasm/vectorize_wasm.js');
                                const wasmUrl = new URL('/wasm/vectorize_wasm_bg.wasm', import.meta.url);
                                await wasmModule.default(wasmUrl);
                                
                                // Check threading
                                let threadingStatus = 'not available';
                                if (self.crossOriginIsolated && wasmModule.initThreadPool) {
                                    const threads = navigator.hardwareConcurrency || 4;
                                    await wasmModule.initThreadPool(threads);
                                    threadingStatus = threads + ' threads';
                                }
                                
                                self.postMessage({
                                    type: 'success',
                                    message: 'WASM loaded successfully',
                                    threading: threadingStatus,
                                    crossOriginIsolated: self.crossOriginIsolated
                                });
                            } catch (error) {
                                self.postMessage({
                                    type: 'error',
                                    message: error.message,
                                    stack: error.stack
                                });
                            }
                        }
                    };
                `;

					const blob = new Blob([workerCode], { type: 'application/javascript' });
					const workerUrl = URL.createObjectURL(blob);
					const worker = new Worker(workerUrl, { type: 'module' });

					log('Worker created successfully', 'pass');

					// Set up message handler
					worker.onmessage = (event) => {
						if (event.data.type === 'success') {
							log(`✓ ${event.data.message}`, 'pass');
							log(`Threading: ${event.data.threading}`, 'info');
							log(
								`Worker crossOriginIsolated: ${event.data.crossOriginIsolated}`,
								event.data.crossOriginIsolated ? 'pass' : 'fail'
							);
						} else if (event.data.type === 'error') {
							log(`❌ Worker error: ${event.data.message}`, 'fail');
							console.error('Worker error details:', event.data);
						}
					};

					worker.onerror = (error) => {
						log(`❌ Worker error: ${error.message}`, 'fail');
						console.error('Worker error:', error);
					};

					// Send init message
					log('Sending init message to worker...', 'info');
					worker.postMessage({ type: 'init' });
				} catch (error) {
					log(`❌ Failed to create worker: ${error.message}`, 'fail');
					console.error(error);
				}
			};
		</script>
	</body>
</html>
