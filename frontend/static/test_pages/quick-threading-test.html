<!doctype html>
<html>
	<head>
		<title>Quick Threading Test</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 20px;
			}
			.result {
				padding: 10px;
				margin: 5px 0;
				border-radius: 5px;
			}
			.success {
				background: #d4edda;
				color: #155724;
			}
			.error {
				background: #f8d7da;
				color: #721c24;
			}
			.info {
				background: #d1ecf1;
				color: #0c5460;
			}
		</style>
	</head>
	<body>
		<h1>Quick WASM Threading Test</h1>
		<div id="results"></div>

		<script type="module">
			function addResult(message, type = 'info') {
				const div = document.createElement('div');
				div.className = `result ${type}`;
				div.textContent = message;
				document.getElementById('results').appendChild(div);
			}

			async function runTest() {
				try {
					addResult('üîÑ Loading WASM module...', 'info');

					// Import WASM
					const wasm = await import('/wasm/vectorize_wasm.js');
					await wasm.default();

					addResult('‚úÖ WASM loaded successfully', 'success');

					// Check threading functions
					addResult(`Threading supported: ${wasm.is_threading_supported()}`, 'info');
					addResult(`Thread count: ${wasm.get_thread_count()}`, 'info');
					addResult(`Hardware concurrency: ${wasm.get_hardware_concurrency()}`, 'info');

					// Check if initThreadPool exists
					if (typeof wasm.initThreadPool === 'function') {
						addResult('‚úÖ initThreadPool function available', 'success');

						try {
							addResult('üîÑ Initializing thread pool...', 'info');
							const result = await wasm.initThreadPool();
							addResult(`‚úÖ Thread pool initialized: ${result}`, 'success');

							const newThreadCount = wasm.get_thread_count();
							addResult(`Thread count after init: ${newThreadCount}`, 'info');

							if (newThreadCount > 1) {
								addResult('üéâ MULTITHREADING IS WORKING!', 'success');
							} else {
								addResult('‚ö†Ô∏è Still single-threaded (may be fallback)', 'info');
							}
						} catch (initError) {
							addResult(`‚ö†Ô∏è Thread init failed: ${initError.message}`, 'error');
						}
					} else {
						addResult('‚ùå initThreadPool function not found', 'error');
					}

					// Get detailed threading info
					const info = wasm.get_threading_info();
					addResult(`Threading info: ${info}`, 'info');

					// Environment checks
					addResult(
						`Cross-origin isolated: ${window.crossOriginIsolated}`,
						window.crossOriginIsolated ? 'success' : 'error'
					);
					addResult(
						`SharedArrayBuffer available: ${typeof SharedArrayBuffer !== 'undefined'}`,
						typeof SharedArrayBuffer !== 'undefined' ? 'success' : 'error'
					);
				} catch (error) {
					addResult(`‚ùå Test failed: ${error.message}`, 'error');
					console.error('Threading test error:', error);
				}
			}

			// Run test on page load
			runTest();
		</script>
	</body>
</html>
