<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Background Removal WASM Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .results {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005f8a;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
        }
        .error {
            color: #ff4444;
        }
        .success {
            color: #44ff44;
        }
        .info {
            color: #4444ff;
        }
    </style>
</head>
<body>
    <h1>vec2art Background Removal WASM Test</h1>
    <p>This test verifies that background removal configuration is working at the WASM level.</p>

    <div class="test-section">
        <h2>WASM Module Status</h2>
        <div id="wasmStatus">Loading WASM module...</div>
        <button onclick="testCapabilities()">Test Capabilities</button>
        <button onclick="testBackgroundRemovalBinding()">Test Background Removal Bindings</button>
    </div>

    <div class="test-section">
        <h2>Background Removal Configuration Test</h2>
        <div>
            <label>
                <input type="checkbox" id="enableBg" onchange="updateConfig()"> Enable Background Removal
            </label>
        </div>
        <div>
            <label>Algorithm: 
                <select id="algorithm" onchange="updateConfig()" style="background: white; color: black; padding: 4px; border: 1px solid #ccc;">
                    <option value="otsu">OTSU (Fast)</option>
                    <option value="adaptive">Adaptive (Better Quality)</option>
                </select>
            </label>
        </div>
        <div>
            <label>Strength: 
                <input type="range" id="strength" min="0" max="1" step="0.1" value="0.5" oninput="updateConfig()">
                <span id="strengthValue">0.5</span>
            </label>
        </div>
        <button onclick="testConfiguration()">Test Configuration</button>
        <button onclick="exportConfiguration()">Export Configuration</button>
    </div>

    <div class="test-section">
        <h2>Image Processing Test</h2>
        <input type="file" id="imageInput" accept="image/*" onchange="loadImage()">
        <canvas id="testCanvas" width="200" height="200" style="border: 1px solid #ddd;"></canvas>
        <button onclick="processImage(false)" id="processWithout">Process WITHOUT Background Removal</button>
        <button onclick="processImage(true)" id="processWithBg">Process WITH Background Removal</button>
        <div id="processingResults"></div>
    </div>

    <div class="test-section">
        <h2>Console Log</h2>
        <div class="log" id="consoleLog"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script type="module">
        let wasmModule = null;
        let vectorizer = null;
        let testImageData = null;

        function log(message, type = 'info') {
            const logElement = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        window.log = log;
        window.clearLog = () => {
            document.getElementById('consoleLog').innerHTML = '';
        };

        // Initialize WASM
        async function initWASM() {
            try {
                log('Loading WASM module from /wasm/vectorize_wasm.js...', 'info');
                const wasmModule = await import('/wasm/vectorize_wasm.js');
                await wasmModule.default();
                log('WASM module loaded successfully!', 'success');
                
                // Test threading support
                try {
                    const threadCount = wasmModule.initThreadPool ? 4 : 0;
                    if (threadCount > 0) {
                        await wasmModule.initThreadPool(threadCount);
                        wasmModule.confirm_threading_success();
                        log(`Threading initialized with ${threadCount} threads`, 'success');
                    } else {
                        log('Threading not supported, using single-threaded mode', 'info');
                    }
                } catch (e) {
                    log(`Threading initialization failed: ${e.message}`, 'error');
                }

                vectorizer = new wasmModule.WasmVectorizer();
                log('WasmVectorizer instance created', 'success');
                document.getElementById('wasmStatus').innerHTML = '<span style="color: green;">✓ WASM Module Ready</span>';
                
                return wasmModule;
            } catch (error) {
                log(`Failed to initialize WASM: ${error.message}`, 'error');
                document.getElementById('wasmStatus').innerHTML = '<span style="color: red;">✗ WASM Module Failed</span>';
                throw error;
            }
        }

        window.testCapabilities = async () => {
            if (!wasmModule) return;
            try {
                const capabilities = wasmModule.check_threading_requirements();
                log(`Capabilities: ${JSON.stringify(capabilities, null, 2)}`, 'info');
            } catch (e) {
                log(`Capabilities test failed: ${e.message}`, 'error');
            }
        };

        window.testBackgroundRemovalBinding = () => {
            if (!vectorizer) {
                log('Vectorizer not initialized', 'error');
                return;
            }
            
            try {
                log('Testing background removal bindings...', 'info');
                
                // Test enable/disable
                vectorizer.enable_background_removal(true);
                log('✓ enable_background_removal(true) - OK', 'success');
                
                vectorizer.enable_background_removal(false);
                log('✓ enable_background_removal(false) - OK', 'success');
                
                // Test strength setting
                vectorizer.set_background_removal_strength(0.7);
                log('✓ set_background_removal_strength(0.7) - OK', 'success');
                
                // Test algorithm setting
                vectorizer.set_background_removal_algorithm('otsu');
                log('✓ set_background_removal_algorithm("otsu") - OK', 'success');
                
                vectorizer.set_background_removal_algorithm('adaptive');
                log('✓ set_background_removal_algorithm("adaptive") - OK', 'success');
                
                vectorizer.set_background_removal_algorithm('auto');
                log('✓ set_background_removal_algorithm("auto") - OK', 'success');
                
                // Test threshold setting
                vectorizer.set_background_removal_threshold(128);
                log('✓ set_background_removal_threshold(128) - OK', 'success');
                
                vectorizer.set_background_removal_threshold(null);
                log('✓ set_background_removal_threshold(null) - OK', 'success');
                
                log('All background removal bindings are working correctly!', 'success');
                
            } catch (error) {
                log(`Background removal binding test failed: ${error.message}`, 'error');
            }
        };

        window.updateConfig = () => {
            if (!vectorizer) return;
            
            const enabled = document.getElementById('enableBg').checked;
            const algorithm = document.getElementById('algorithm').value;
            const strength = parseFloat(document.getElementById('strength').value);
            
            document.getElementById('strengthValue').textContent = strength;
            
            try {
                log(`Updating configuration: enabled=${enabled}, algorithm=${algorithm}, strength=${strength}`, 'info');
                
                vectorizer.enable_background_removal(enabled);
                vectorizer.set_background_removal_algorithm(algorithm);
                vectorizer.set_background_removal_strength(strength);
                
                log('Configuration updated successfully', 'success');
            } catch (error) {
                log(`Configuration update failed: ${error.message}`, 'error');
            }
        };

        window.testConfiguration = () => {
            if (!vectorizer) return;
            
            try {
                vectorizer.validate_config();
                log('Configuration validation passed', 'success');
            } catch (error) {
                log(`Configuration validation failed: ${error.message}`, 'error');
            }
        };

        window.exportConfiguration = () => {
            if (!vectorizer) return;
            
            try {
                const config = vectorizer.export_config();
                log(`Exported configuration: ${config}`, 'info');
                
                // Parse and check background removal settings
                const configObj = JSON.parse(config);
                log(`Background Removal Enabled: ${configObj.enable_background_removal}`, 'info');
                log(`Background Removal Algorithm: ${configObj.background_removal_algorithm}`, 'info');
                log(`Background Removal Strength: ${configObj.background_removal_strength}`, 'info');
            } catch (error) {
                log(`Configuration export failed: ${error.message}`, 'error');
            }
        };

        window.loadImage = () => {
            const file = document.getElementById('imageInput').files[0];
            if (!file) return;
            
            const canvas = document.getElementById('testCanvas');
            const ctx = canvas.getContext('2d');
            
            const img = new Image();
            img.onload = () => {
                // Draw image to canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // Get image data
                testImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                log(`Image loaded: ${testImageData.width}x${testImageData.height}`, 'success');
                
                document.getElementById('processWithout').disabled = false;
                document.getElementById('processWithBg').disabled = false;
            };
            img.src = URL.createObjectURL(file);
        };

        window.processImage = async (withBackgroundRemoval) => {
            if (!vectorizer || !testImageData) {
                log('Vectorizer or image not ready', 'error');
                return;
            }
            
            try {
                log(`Processing image ${withBackgroundRemoval ? 'WITH' : 'WITHOUT'} background removal...`, 'info');
                
                // Configure background removal
                vectorizer.enable_background_removal(withBackgroundRemoval);
                if (withBackgroundRemoval) {
                    const algorithm = document.getElementById('algorithm').value;
                    const strength = parseFloat(document.getElementById('strength').value);
                    vectorizer.set_background_removal_algorithm(algorithm);
                    vectorizer.set_background_removal_strength(strength);
                    log(`Using algorithm: ${algorithm}, strength: ${strength}`, 'info');
                }
                
                const startTime = performance.now();
                
                // Create Web-compatible ImageData
                const wasmImageData = new ImageData(
                    new Uint8ClampedArray(testImageData.data),
                    testImageData.width,
                    testImageData.height
                );
                
                // Process with WASM
                const result = vectorizer.vectorize_rgba_image_data(wasmImageData);
                
                const endTime = performance.now();
                const processingTime = (endTime - startTime).toFixed(2);
                
                log(`Processing completed in ${processingTime}ms`, 'success');
                log(`SVG length: ${result.length} characters`, 'info');
                
                // Count paths/circles
                const pathCount = (result.match(/<path/g) || []).length;
                const circleCount = (result.match(/<circle/g) || []).length;
                const elementCount = pathCount + circleCount;
                
                log(`Generated elements: ${elementCount} (${pathCount} paths, ${circleCount} circles)`, 'info');
                
                const resultsDiv = document.getElementById('processingResults');
                const testType = withBackgroundRemoval ? 'WITH Background Removal' : 'WITHOUT Background Removal';
                resultsDiv.innerHTML += `
                    <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0;">
                        <h4>${testType}</h4>
                        <p>Processing Time: ${processingTime}ms</p>
                        <p>Elements Generated: ${elementCount}</p>
                        <p>SVG Size: ${result.length} characters</p>
                    </div>
                `;
                
            } catch (error) {
                log(`Processing failed: ${error.message}`, 'error');
            }
        };

        // Initialize when page loads
        window.addEventListener('load', async () => {
            try {
                wasmModule = await initWASM();
                document.getElementById('processWithout').disabled = true;
                document.getElementById('processWithBg').disabled = true;
            } catch (error) {
                log(`Initialization failed: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>