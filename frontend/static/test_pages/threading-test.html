<!DOCTYPE html>
<html>
<head>
    <title>Enhanced Threading System Test</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .warning { background-color: #fff3cd; color: #856404; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; }
        #output { border: 1px solid #ccc; padding: 10px; margin: 10px 0; height: 400px; overflow-y: scroll; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Enhanced Threading System Test</h1>
    
    <div id="status" class="status info">Loading WASM module...</div>
    
    <div>
        <button onclick="testThreadingCapabilities()">Test Threading Capabilities</button>
        <button onclick="testAlgorithmControls()">Test Algorithm Controls</button>
        <button onclick="testEdgeDetection()">Test Edge Detection (Safe Threading)</button>
        <button onclick="clearOutput()">Clear Output</button>
    </div>
    
    <div id="output"></div>

    <script type="module">
        let wasm = null;
        let wasmModule = null;

        function log(message) {
            const output = document.getElementById('output');
            output.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        async function initializeWasm() {
            try {
                log('Initializing WASM module with enhanced threading...');
                
                // Import the WASM module
                wasmModule = await import('/wasm/vectorize_wasm.js');
                await wasmModule.default();
                wasm = wasmModule;
                
                log('‚úÖ WASM module loaded successfully');
                
                // Test basic functions
                if (typeof wasm.get_version === 'function') {
                    const version = wasm.get_version();
                    log(`üì¶ WASM Version: ${version}`);
                }
                
                // Test threading capabilities
                if (typeof wasm.is_threading_supported === 'function') {
                    const threadingSupported = wasm.is_threading_supported();
                    log(`üßµ Threading supported: ${threadingSupported}`);
                }
                
                if (typeof wasm.get_thread_count === 'function') {
                    const threadCount = wasm.get_thread_count();
                    log(`‚öôÔ∏è Current thread count: ${threadCount}`);
                }
                
                updateStatus('WASM module loaded with enhanced threading support', 'success');
                
            } catch (error) {
                log(`‚ùå Failed to initialize WASM: ${error}`);
                updateStatus('Failed to load WASM module', 'error');
                throw error;
            }
        }

        window.testThreadingCapabilities = function() {
            if (!wasm) {
                log('‚ùå WASM not initialized');
                return;
            }
            
            try {
                log('\nüîç Testing Threading Capabilities:');
                
                // Test threading functions
                const functions = [
                    'is_threading_supported',
                    'get_thread_count',
                    'get_threading_info',
                    'has_threading_failed'
                ];
                
                functions.forEach(funcName => {
                    if (typeof wasm[funcName] === 'function') {
                        try {
                            const result = wasm[funcName]();
                            log(`  ‚úÖ ${funcName}(): ${result}`);
                        } catch (e) {
                            log(`  ‚ùå ${funcName}(): Error - ${e.message}`);
                        }
                    } else {
                        log(`  ‚ö†Ô∏è ${funcName}: Function not available`);
                    }
                });
                
                // Test SharedArrayBuffer availability
                const hasSharedArrayBuffer = typeof SharedArrayBuffer !== 'undefined';
                log(`  üîó SharedArrayBuffer available: ${hasSharedArrayBuffer}`);
                
                // Test Cross-Origin Isolation
                const hasCoepCoopHeaders = window.crossOriginIsolated;
                log(`  üõ°Ô∏è Cross-Origin Isolated: ${hasCoepCoopHeaders}`);
                
                log('‚úÖ Threading capabilities test complete');
                
            } catch (error) {
                log(`‚ùå Threading test failed: ${error}`);
            }
        };

        window.testAlgorithmControls = function() {
            if (!wasm) {
                log('‚ùå WASM not initialized');
                return;
            }
            
            try {
                log('\nüéõÔ∏è Testing Algorithm Controls:');
                
                // Test if algorithm-specific functions exist
                const algorithmFunctions = [
                    'create_threading_config',
                    'set_algorithm_threading',
                    'get_algorithm_threading_status'
                ];
                
                algorithmFunctions.forEach(funcName => {
                    if (typeof wasm[funcName] === 'function') {
                        log(`  ‚úÖ ${funcName}: Available`);
                    } else {
                        log(`  ‚ö†Ô∏è ${funcName}: Not available (expected for Phase 1)`);
                    }
                });
                
                log('‚úÖ Algorithm controls test complete');
                
            } catch (error) {
                log(`‚ùå Algorithm controls test failed: ${error}`);
            }
        };

        window.testEdgeDetection = function() {
            if (!wasm) {
                log('‚ùå WASM not initialized');
                return;
            }
            
            try {
                log('\nüî¨ Testing Edge Detection with Safe Threading:');
                
                // Create a simple test image
                const width = 100;
                const height = 100;
                const imageData = new ImageData(width, height);
                
                // Fill with a simple pattern
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const index = (y * width + x) * 4;
                        imageData.data[index] = x % 2 === 0 ? 255 : 0; // Red
                        imageData.data[index + 1] = y % 2 === 0 ? 255 : 0; // Green
                        imageData.data[index + 2] = 100; // Blue
                        imageData.data[index + 3] = 255; // Alpha
                    }
                }
                
                log(`  üìê Created test image: ${width}x${height}`);
                
                // Test edge detection function if available
                if (typeof wasm.analyze_image_gradients === 'function') {
                    log('  üîç Testing gradient analysis...');
                    // Note: This would need proper integration with the WASM interface
                    log('  ‚ö†Ô∏è Full edge detection test requires proper image buffer setup');
                } else {
                    log('  ‚ö†Ô∏è analyze_image_gradients function not available');
                }
                
                log('‚úÖ Edge detection test structure verified');
                
            } catch (error) {
                log(`‚ùå Edge detection test failed: ${error}`);
            }
        };

        window.clearOutput = function() {
            document.getElementById('output').textContent = '';
        };

        // Initialize on page load
        window.addEventListener('load', async () => {
            try {
                await initializeWasm();
            } catch (error) {
                console.error('Failed to initialize:', error);
            }
        });
    </script>
</body>
</html>