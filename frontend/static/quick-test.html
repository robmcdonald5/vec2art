<!DOCTYPE html>
<html>
<head>
    <title>Quick WASM Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #e0e0e0; }
        pre { background: #2a2a2a; padding: 10px; border-radius: 4px; }
        .success { color: #4caf50; }
        .error { color: #f44336; }
    </style>
</head>
<body>
    <h1>Quick WASM Test</h1>
    <pre id="output">Loading...</pre>

    <script type="module">
        const output = document.getElementById('output');
        
        async function test() {
            try {
                // Import the WASM module directly from static files
                const module = await import('/wasm/vectorize_wasm.js');
                output.innerHTML += '\n<span class="success">âœ“ Module imported</span>';
                
                // Initialize WASM
                await module.default('/wasm/vectorize_wasm_bg.wasm');
                output.innerHTML += '\n<span class="success">âœ“ WASM initialized</span>';
                
                // Check for WasmVectorizer
                if (module.WasmVectorizer) {
                    output.innerHTML += '\n<span class="success">âœ“ WasmVectorizer found</span>';
                    
                    // Create a simple test image (4x4 pixels, all white)
                    const width = 4;
                    const height = 4;
                    const pixels = new Uint8ClampedArray(width * height * 4);
                    pixels.fill(255); // All white
                    
                    // Create an ImageData object (web API)
                    const imageData = new ImageData(pixels, width, height);
                    output.innerHTML += '\n<span class="success">âœ“ ImageData created</span>';
                    
                    // Create vectorizer (no arguments for constructor)
                    const vectorizer = new module.WasmVectorizer();
                    output.innerHTML += '\n<span class="success">âœ“ Vectorizer created</span>';
                    
                    // Check available methods
                    const methods = Object.getOwnPropertyNames(Object.getPrototypeOf(vectorizer));
                    output.innerHTML += `\n<span class="success">Available methods: ${methods.filter(m => !m.startsWith('__')).join(', ')}</span>`;
                    
                    // Set a specific backend and preset to avoid defaults
                    if (module.WasmBackend && module.WasmBackend.Edge) {
                        vectorizer.set_backend(module.WasmBackend.Edge);
                        output.innerHTML += '\n<span class="success">âœ“ Backend set to Edge</span>';
                    }
                    
                    if (module.WasmPreset && module.WasmPreset.LineArt) {
                        vectorizer.use_preset(module.WasmPreset.LineArt);
                        output.innerHTML += '\n<span class="success">âœ“ Preset set to LineArt</span>';
                    }
                    
                    // Call vectorize with ImageData
                    try {
                        const svg = vectorizer.vectorize(imageData);
                        output.innerHTML += '\n<span class="success">âœ“ Processing complete</span>';
                        output.innerHTML += `\n<span class="success">âœ“ SVG length: ${svg.length} chars</span>`;
                        
                        // Show first part of SVG
                        const preview = svg.substring(0, 200);
                        output.innerHTML += `\n<span class="success">SVG preview: ${preview}...</span>`;
                    } catch (wasmError) {
                        throw new Error(`WASM processing failed: ${wasmError.message || wasmError}`);
                    }
                    
                    // Clean up
                    vectorizer.free();
                    output.innerHTML += '\n<span class="success">âœ“ Memory freed</span>';
                    
                    output.innerHTML += '\n\n<span class="success">ðŸŽ‰ ALL TESTS PASSED!</span>';
                } else {
                    throw new Error('WasmVectorizer not found in module');
                }
                
            } catch (error) {
                output.innerHTML += `\n<span class="error">âœ— Error: ${error.message}</span>`;
                console.error(error);
            }
        }
        
        test();
    </script>
</body>
</html>